name: Verify Attestation

on:
  workflow_call:
    secrets:
      token:
        required: true

jobs:
  verify-attestation:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
    steps:
    - name: Download attestation
      uses: actions/download-artifact@v4
      with:
        name: attestation.json
    - name: Extract commit SHA from attestation
      id: extract_commit_sha
      run: |
        COMMIT_SHA=$(jq -r '.payload.commit_sha' attestation.json)
        echo "COMMIT_SHA=$COMMIT_SHA" >> $GITHUB_ENV
    - name: Checkout repository at commit SHA
      uses: actions/checkout@v4
      with:
        repository: kipz/url-oracle
        ref: ${{ env.COMMIT_SHA }}
        token: ${{ secrets.token }}
    - name: Verify attestation
      run: |
        go run cmd/verify_attestation/main.go cmd/verify_attestation/verifier.go --attestation-file attestation.json --commit-sha ${{ env.COMMIT_SHA }}

    - name: Comment on commit (if possible)
      run: |
        echo "üîç Verification completed for commit ${{ env.COMMIT_SHA }}"
        echo "üìã Summary: Attestation verified successfully"
