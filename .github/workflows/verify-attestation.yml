name: Verify Attestation

on:
  workflow_call:

jobs:
  verify-attestation:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
    steps:
    - name: Download attestation
      uses: actions/download-artifact@v4
      with:
        name: attestation.json
    - name: Extract commit SHA from attestation
      id: extract_commit_sha
      run: |
        COMMIT_SHA=$(jq -r '.payload.commit_sha' attestation.json)
        echo "COMMIT_SHA=$COMMIT_SHA" >> $GITHUB_ENV
    - name: Verify attestation
      uses: kipz/url-oracle@${{ env.COMMIT_SHA }}
      with:
        command: verify_attestation
        attestation_file: /github/workspace/attestation.json
        commit_sha: ${{ env.COMMIT_SHA }}

    - name: Comment on commit (if possible)
      run: |
        echo "ğŸ” Verification completed for commit ${{ env.COMMIT_SHA }}"
        echo "ğŸ“‹ Summary: Attestation verified successfully"
